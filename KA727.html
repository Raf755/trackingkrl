<!DOCTYPE html>
<html>
<head>
  <title>KRL KA727 Solo Balapan â€“ Yogyakarta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #info {
      position: absolute;
      top: 0; left: 0; right: 0;
      background-color: #a00;
      color: white;
      padding: 8px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 1000;
    }
  </style>
</head>
<body>
<div id="info">
  <strong>Kereta KRL KA727 Solo Balapan â€“ Yogyakarta</strong><br>
  Rute: Solo Balapan â†’ Yogyakarta<br>
  Status: <span id="status">Mendeteksi...</span><br>
  ğŸŒ¡ Suhu: N/A â„ƒ | ğŸ” Kecepatan: <span id="speed">0.0</span> km/jam |
  ğŸ“ Stasiun berikutnya: <span id="next">-</span> ğŸ“ Jarak: <span id="jarak">-</span> km
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([-7.6, 110.7], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Leaflet | Â© OpenStreetMap contributors'
  }).addTo(map);

  const stasiun = [
    { nama: "Solo Balapan", lat: -7.556868, lon: 110.821221 },
    { nama: "Purwosari", lat: -7.561491, lon: 110.796383 },
    { nama: "Gawok", lat: -7.589437, lon: 110.744549 },
    { nama: "Delanggu", lat: -7.622235, lon: 110.706595 },
    { nama: "Ceper", lat: -7.668951, lon: 110.674844 },
    { nama: "Klaten", lat: -7.712433, lon: 110.602911 },
    { nama: "Srowot", lat: -7.741498, lon: 110.549159 },
    { nama: "Brambanan", lat: -7.756670, lon: 110.500398 },
    { nama: "Maguwo", lat: -7.785123, lon: 110.436743 },
    { nama: "Lempuyangan", lat: -7.790080, lon: 110.375413 },
    { nama: "Yogyakarta", lat: -7.789328, lon: 110.363068 }
  ];

  stasiun.forEach(s => {
    L.marker([s.lat, s.lon]).addTo(map).bindPopup(s.nama);
  });

  const jalur = L.polyline(stasiun.map(s => [s.lat, s.lon]), { color: 'red' }).addTo(map);
  const keretaIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/809/809957.png', iconSize: [30, 30] });
  const markerKereta = L.marker([-7.556, 110.82], { icon: keretaIcon }).addTo(map);

  let indeksStasiun = 0;

  function hitungJarak(lat1, lon1, lat2, lon2) {
    const R = 6371; // km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function updatePosisi(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0;

    markerKereta.setLatLng([lat, lon]);
    document.getElementById("speed").textContent = speed;

    // Status otomatis
    document.getElementById("status").textContent = speed > 0.5 ? "Berjalan" : "Berhenti";

    // Deteksi stasiun berikutnya
    if (indeksStasiun < stasiun.length) {
      const stasiunSekarang = stasiun[indeksStasiun];
      const jarak = hitungJarak(lat, lon, stasiunSekarang.lat, stasiunSekarang.lon);
      document.getElementById("jarak").textContent = jarak.toFixed(2);

      // Ganti ke stasiun berikutnya jika sudah lewat 0.3 km
      if (jarak >= 0.3 && indeksStasiun < stasiun.length - 1) {
        indeksStasiun++;
      }

      // Tampilkan nama stasiun berikutnya
      if (indeksStasiun < stasiun.length) {
        document.getElementById("next").textContent = stasiun[indeksStasiun].nama;
      } else {
        document.getElementById("next").textContent = "Akhir perjalanan";
      }
    }
  }

  function gagal(error) {
    alert("Gagal mendeteksi lokasi: " + error.message);
  }

  navigator.geolocation.watchPosition(updatePosisi, gagal, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 5000
  });
</script>
</body>
</html>
